function showErrorMsg(msg,XMLHttpRequest,textStatus){var err="";if(XMLHttpRequest.status==401){err="登录超时，请重新登录"
}else{if(msg!=""){err=msg}if(XMLHttpRequest.responseText==""){err+=XMLHttpRequest.status+XMLHttpRequest.statusText+textStatus
}else{err+=XMLHttpRequest.responseText}console.log(msg+XMLHttpRequest.status+XMLHttpRequest.statusText+textStatus+"\r\n"+XMLHttpRequest.responseText)
}var myStack={dir1:"down",dir2:"right",push:"top",spacing1:0,spacing2:0};new PNotify({title:"系统提示",text:err,type:"error",addclass:"stack-bar-top",stack:myStack,icon:"fa fa-exclamation-triangle fa-4x",buttons:{sticker:false,closer_hover:false},delay:5000,hide:true,width:"35%"})
}function showMsg(str){var myStack={dir1:"down",dir2:"right",push:"top",spacing1:0,spacing2:0};
new PNotify({title:"系统提示",text:str,type:"success",addclass:"stack-bar-top",stack:myStack,icon:"fa fa-exclamation-triangle fa-4x",buttons:{sticker:false,closer_hover:false},delay:3000,hide:true,width:"35%"})
}function checkRemarkLength(ctrl){if(ctrl.value.length>=60){event.returnValue=false
}}$.extend($.fn.dataTable.defaults,{oLanguage:{sProcessing:"处理中...",sLengthMenu:"显示 _MENU_ 项结果",sZeroRecords:"没有匹配结果",sInfo:"显示第 _START_ 至 _END_ 项结果，共 _TOTAL_ 项",sInfoEmpty:"显示第 0 至 0 项结果，共 0 项",sInfoFiltered:"(由 _MAX_ 项结果过滤)",sInfoPostFix:"",sSearch:"搜索:",sUrl:"",sEmptyTable:"表中数据为空",sLoadingRecords:"载入中...",sInfoThousands:",",oPaginate:{sFirst:"首页",sPrevious:"上页",sNext:"下页",sLast:"末页"},oAria:{sSortAscending:": 以升序排列此列",sSortDescending:": 以降序排列此列"}}});
$.fn.dataTable.pipeline=function(opts){var conf=$.extend({pages:5,url:"",data:null,method:"GET"},opts);
var cacheLower=-1;var cacheUpper=null;var cacheLastRequest=null;var cacheLastJson=null;
return function(request,drawCallback,settings){var ajax=false;var requestStart=request.start;
var drawStart=request.start;var requestLength=request.length;var requestEnd=requestStart+requestLength;
draw++;if(settings.clearCache){ajax=true;settings.clearCache=false}else{if(cacheLower<0||requestStart<cacheLower||requestEnd>cacheUpper){ajax=true
}else{if(JSON.stringify(request.order)!==JSON.stringify(cacheLastRequest.order)||JSON.stringify(request.columns)!==JSON.stringify(cacheLastRequest.columns)||JSON.stringify(request.search)!==JSON.stringify(cacheLastRequest.search)){ajax=true
}}}cacheLastRequest=$.extend(true,{},request);if(ajax){if(requestStart<cacheLower){requestStart=requestStart-(requestLength*(conf.pages-1));
if(requestStart<0){requestStart=0}}cacheLower=requestStart;cacheUpper=requestStart+(requestLength*conf.pages);
request.start=requestStart;request.length=requestLength*conf.pages;if(typeof conf.data==="function"){var d=conf.data(request);
if(d){$.extend(request,d)}}else{if($.isPlainObject(conf.data)){$.extend(request,conf.data)
}}var requestdata=request;if(conf.dataType){switch(conf.dataType){case"stringify":requestdata=JSON.stringify(request);
break}}settings.jqXHR=$.ajax({type:conf.method,url:conf.url,data:requestdata,dataType:"json",contentType:conf.contentType,cache:false,success:function(json){var data=json;
if(data!=undefined){if(conf.dataconvert){data=conf.dataconvert(json)}if(data!=undefined){cacheLastJson=$.extend(true,{},data);
if(cacheLower!=drawStart){data.data.splice(0,drawStart-cacheLower)}if(requestLength>=-1){data.data.splice(requestLength,data.data.length)
}}else{data={};data.data=[];data.recordsTotal=0;data.recordsFiltered=0}}else{data.data=[];
data.recordsTotal=0;data.recordsFiltered=0}drawCallback(data)},error:function(XMLHttpRequest,textStatus){showErrorMsg("查询数据出错",XMLHttpRequest,textStatus)
},complete:function(){request={}}})}else{json=$.extend(true,{},cacheLastJson);json.draw=request.draw;
json.data.splice(0,requestStart-cacheLower);json.data.splice(requestLength,json.data.length);
drawCallback(json)}}};$.fn.dataTable.Api.register("clearPipeline()",function(){return this.iterator("table",function(settings){settings.clearCache=true
})});function convertBorrowType(borrow_type){var type=[];$.each(borrow_type,function(i,n){switch(n){case"view":type.push("查看");
break;case"print":type.push("打印");break;case"download":type.push("下载");break}});return type
}function convertApplyStatus(status){var applicationstatus="";switch(status){case"register":applicationstatus="审批通过";
break;case"approvaling":applicationstatus="审批中";break;case"approval_success":applicationstatus="正在登记";
break;case"approval_fail":applicationstatus="已拒绝";break}return applicationstatus}function convertRole(role_name){var role="";
switch(role_name){case"FRONT_STAFF":role="员工";break;case"DEPARTMENT_LEADER":role="部门领导";
break;case"CENTER_LEADER":role="中心领导";break;case"EARCHIVES_LEADER":role="档案室领导";break;
case"EARCHIVES_STAFF":role="档案室员工";break}return role}function showProcessDialog(apply_id){var url="/earchivesApproval/fullProcess";
var postdata={};postdata.apply_id=apply_id;var dataJson=JSON.stringify(postdata);
$.ajax({type:"Post",url:url,data:dataJson,contentType:"application/json;charset=UTF-8",success:function(data){console.log(data);
var applyMap=data.earchivesApplyMap;var approvalList=data.earchivesApprovalList;var registerMap=data.earchivesRegisterMap;
var apply_status=convertApplyStatus(applyMap.apply_status);var apply_process=convertRole(applyMap.apply_process);
if(apply_status.indexOf("正在登记")!=-1){apply_process="档案室员工"}if(apply_status.indexOf("审批通过")!=-1){apply_process=""
}processinfoHtml="";var processinfo={};processinfo.time=applyMap.apply_time;processinfo.name=applyMap.apply_account_name;
processinfo.event="动作：发起申请";processinfo.otherinfo0="当前状态："+apply_process+apply_status;
processinfoHtml=processDiv(processinfo);$.each(approvalList,function(i,n){var result=n.approval_result;
if(result=="success"){result="审批通过"}else{if(result=="fail"){result="已拒绝"}else{result="未审批"
}}processinfo.time=n.approval_time;processinfo.name=n.approval_account_name;processinfo.event="动作："+convertRole(n.role_name)+"审批";
processinfo.otherinfo0="审批结果："+result;processinfo.otherinfo1="审批备注："+n.approval_remark;
processinfoHtml+=processDiv(processinfo)});if(registerMap&&registerMap!=null&&registerMap.register_time!=null){var borrow_starttime=moment(registerMap.borrow_starttime).format("YYYY年MM月DD日");
var borrow_endtime=moment(registerMap.borrow_endtime).format("YYYY年MM月DD日");processinfo.time=registerMap.register_time;
processinfo.name=registerMap.register_account_name;processinfo.event="动作：档案借出登记";
processinfo.otherinfo0="使用时间："+borrow_starttime+" 至 "+borrow_endtime;processinfo.otherinfo1="备注："+registerMap.borrow_remark;
processinfoHtml+=processDiv(processinfo)}$("#processInfo").html(processinfoHtml)},error:function(XMLHttpRequest,textStatus){}});
$("#processModal").modal("show")}function processDiv(processinfo){var time=moment(processinfo.time).format("YYYY年MM月DD日 H:mm:ss");
var html="";html+='<div class="col-6 mt-4">';html+="<div>";html+='<div class="col-12"><span class="pull-right">'+time+"</span></div>";
html+='<div class="col-6 mt-1 pull-right">';html+='<i class="fa fa-user-o fa-2x ml-3 mr-3" aria-hidden="true"></i>';
html+="<span>"+processinfo.name+"</span>";html+="</div>";html+="</div>";html+="</div>";
html+='<div class="col-6 mt-3">';html+="<div>";html+='<div class="mt-2"><span>'+processinfo.event+"</span></div>";
if(processinfo.otherinfo0){html+='<div class="mt-2"><span>'+processinfo.otherinfo0+"</span></div>"
}if(processinfo.otherinfo1){html+='<div class="mt-2"><span>'+processinfo.otherinfo1+"</span></div>"
}html+="</div>";html+="</div>";return html}function checkMetacharacter(str){var items=["~","`","!","@","#","$","=","^","&","*","(",")","|","\\","<",">","?","（","）","【","【","”","“","‘","’",'"'];
for(var i=0;i<items.length;i++){if(str.indexOf(items[i])>=0){str=str.split(items[i]).join("")
}}return str};